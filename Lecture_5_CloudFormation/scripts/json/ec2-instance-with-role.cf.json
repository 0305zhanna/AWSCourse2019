{
    "Description": "AWS CloudFormation Sample Template ec2_instance_with_instance_profile: Create an EC2 instance with an associated instance profile. **WARNING** This template creates one or more Amazon EC2 instances and an Amazon SQS queue. You will be billed for the AWS resources used if you create a stack from this template.",

    "AWSTemplateFormatVersion": "2010-09-09",

    "Parameters" : {

        "KeyName" : {
            "Description" : "Name of and existing EC2 KeyPair to enable SSH access to the instance",
            "Type" : "String"
        }
    },

    "Mappings": {
            "RegionMap" : {
              "us-east-1"      : { "AMI" : "ami-05355a6c" },
              "us-west-1"      : { "AMI" : "ami-0358ce33" },
              "us-west-2"      : { "AMI" : "ami-3ffed17a" },
              "eu-west-1"      : { "AMI" : "ami-c7c0d6b3" },
              "sa-east-1"      : { "AMI" : "ami-fade91a8" },
              "ap-southeast-1" : { "AMI" : "ami-39b23d38" },
              "ap-southeast-2" : { "AMI" : "ami-d16bfbeb" },
              "ap-northeast-1" : { "AMI" : "ami-5253894f" }
            }
    },

    "Resources": {
        "S3FtpInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "KeyName" : { "Ref" : "KeyName" },
                "ImageId" : { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "AMI" ]},
                "InstanceType" : "t1.micro",
                "SecurityGroups" : [{ "Ref" : "InstanceSecurityGroup" }],
                "IamInstanceProfile": {
                    "Ref": "RootInstanceProfile"
                }
            }
        },
        "RootRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/"
            }
        },
        "RolePolicies": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "root",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RootRole"
                    }
                ]
            }
        },
        "RootInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "RootRole"
                    }
                ]
            }
        },

        "InstanceSecurityGroup" : {
            "Type" : "AWS::EC2::SecurityGroup",
            "Properties" : {
                "GroupDescription" : "Enable SSH access via port 22",
                "SecurityGroupIngress" : [
                    { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0"}
                ]
            }
        }
    },

    "Outputs" : {
        "DNSName" : {
            "Description" : "DNS Name of the EC2instance",
            "Value" :  { "Fn::GetAtt" : [ "S3FtpInstance", "PublicDnsName" ]}
        }
    }
}